---
title: "lmmHeterosced"
author: "Geir H. Bolstad"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Weight}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
<!---  
output: 
  word_document:
    fig_caption: true
-->


<!--- 
                          NB! Build & Reload does not create a vignette 
                          use devtools::build(), or use menu for 
                          building source package
                          or devtools::build_vignettes()
-->


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(lmmHeterosced)
```

# Simulated data
```{r data}
n_cat <- 10
n <- 50
d <- data.frame(x = rnorm(n*n_cat, 2, 1), cat = rep(1:n_cat, each = n))
d$y <- rnorm(nrow(d), 1+0.5*x, exp(0.5*(1+0.5*d$x))) + rep(rnorm(n_cat), each = n)
with(d, plot(x,y))
```

# The model
```{r analysis}
mod <- lmmHeterosced(formula = y~x+(1|cat), heterosced_formula = ~ 1 + x, data = d)
```

# Results of average change in y
```{r}
mod$Fixef
```

# Results of Heteroscedasticity analysis
The intercept gives the log residual variance at x = 0 and the linear parameter (x) gives the change in log residual variance with x
```{r}
mod$Heterosced
```

# Plot of the model
The black solid line give the change in the average, and dashed lines shows +/- one standard deviation. 
```{r}
with(d, plot(x,y, col = "grey"))
x <- seq(min(d$x), max(d$x), length.out = 100)
a <- mod$Heterosced[1,1]
b <- mod$Heterosced[2,1]
lines(x, mod$Fixef[1,1] + mod$Fixef[2,1]*x)
lines(x, mod$Fixef[1,1] + mod$Fixef[2,1]*x + sqrt(exp(a + b*x)), col = "blue")
lines(x, mod$Fixef[1,1] + mod$Fixef[2,1]*x - sqrt(exp(a + b*x)), col = "blue")
```

# Change in absolute y-values
```{r}
fn_mu<-function(m,s){ # expectation of folded normal
  s*sqrt(2/pi)*exp((-1*m^2)/(2*s^2))+m*(1-2*pnorm(-1*m/s,0,1)) 
}

V <- eigen(mod$error_var_matrix)
eigenv_samples <- sapply(V$values, function(x) rnorm(1000, 0, sqrt(x)))
dist_param <- t(apply(eigenv_samples, 1, function(x) x%*%t(V$vectors)+c(mod$Fixef[,1],mod$Heterosced[,1]))) # Distribution of parameter values
dist_absy <- t(apply(dist_param, 1, function(B) fn_mu(B[1] + B[2]*x, sqrt(exp(B[3] + B[4]*x)))))
low_absy <- apply(dist_absy, 2, function(x) quantile(x, 0.025))
high_absy <- apply(dist_absy, 2, function(x) quantile(x, 0.975))

with(d, plot(x,abs(y), col = "grey"))
lines(x, fn_mu(mod$Fixef[1,1] + mod$Fixef[2,1]*x, sqrt(exp(a + b*x))))
lines(x, low_absy, lty = "dashed")
lines(x, high_absy, lty = "dashed")

```

# Average change in abs(y)
```{r}
Avg_change <- coef(lm(fn_mu(mod$Fixef[1,1] + mod$Fixef[2,1]*d$x, sqrt(exp(a + b*d$x)))~d$x))[2]
Avg_change_dist <- apply(dist_param, 1, function(B) coef(lm(fn_mu(B[1] + B[2]*d$x, sqrt(exp(B[3] + B[4]*d$x)))~d$x))[2])
result <- c(Avg_change, quantile(Avg_change_dist, 0.025), quantile(Avg_change_dist, 0.975))
names(result) <- c("Average change", "Lower 95%", "Upper 95%")
result
```




